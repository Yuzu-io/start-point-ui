<template>
  <div class="container">
    <n-form
      ref="formRef"
      :model="queryParams"
      label-placement="left"
      :show-feedback="false"
      class="search-form"
    >
      <n-flex>
        <n-form-item path="dictName" label="字典名称">
          <n-input v-model:value="queryParams.dictName" placeholder="请输入字典名称"></n-input>
        </n-form-item>

        <n-form-item path="dictType" label="字典类型">
          <n-input v-model:value="queryParams.dictType" placeholder="请输入字典类型"></n-input>
        </n-form-item>

        <n-form-item path="status" label="状态">
          <n-select
            v-model:value="queryParams.status"
            :options="statusOptions"
            clearable
            :label-field="statusSelectFieldNames.labelField"
            :value-field="statusSelectFieldNames.valueField"
            placeholder="请选择状态"
            style="width: 140px"
          />
        </n-form-item>

        <n-form-item>
          <n-button type="primary" @click="getData">搜索</n-button>
          <n-button style="margin: 0 8px" @click="resetForm">重置</n-button>
        </n-form-item>
      </n-flex>
    </n-form>

    <TableHeader
      :isNoSelection="!checkData.length"
      @refresh-click="refresh"
      @add-click="addRow"
      @edit-click="batchEditRow"
      @delete-click="batchDeleteRow"
    ></TableHeader>

    <n-spin :show="show" :delay="delay">
      <n-data-table
        :columns="columns"
        :data="data"
        :row-key="rowKey"
        :pagination="false"
        :scroll-x="scrollX"
        bordered
        :single-line="false"
        @update:checked-row-keys="handleCheck"
      >
      </n-data-table>
    </n-spin>
    <Pagination
      v-model:page="queryParams.pageNum"
      v-model:pageSize="queryParams.pageSize"
      :pageSizes="pageSizes"
      :total="total"
      @update-page="getData"
      @update-page-size="getData"
    ></Pagination>
    <DictAdd ref="dictAddRef" @success="getData"></DictAdd>
    <DictEdit ref="dictEditRef" @success="getData"></DictEdit>
    <DictBatchEdit ref="dictBatchEditRef" @success="getData"></DictBatchEdit>
  </div>
</template>

<script setup lang="ts">
import { onMounted, reactive, ref, h } from 'vue'
import { useMessage, type FormInst, NTooltip, NButton, NPopconfirm, NTag } from 'naive-ui'
import type { RowData } from 'naive-ui/es/data-table/src/interface'
import TableHeader from '@/components/TableHeader/index.vue'
import DictAdd from './add/index.vue'
import DictEdit from './edit/index.vue'
import DictBatchEdit from './batchEdit/index.vue'
import MSIcon from '@/components/MSIcon/index.vue'
import Pagination from '@/components/Pagination/index.vue'
import { mainRouteName } from '@/permission'
import type { DictInfo, GetDictParams } from '@/types/system/dict'
import { batchDeleteDictApi, deleteDictApi, getDictListApi } from '@/api/system/dict'
import { RouterLink } from 'vue-router'
import type { DictDataInfo } from '@/types/system/dictData'
import { useDictStore } from '@/plugins/stores'

const formRef = ref<FormInst>()
const show = ref<boolean>(false)
const delay = 500
const rowKey = (row: IRowData) => row.id
// 表格
const columns = [
  {
    type: 'selection',
    width: 50
  },
  {
    title: '字典名称',
    key: 'dictName',
    width: 160,
    align: 'center',
    ellipsis: true
  },
  {
    title: '字典类型',
    key: 'dictType',
    width: 160,
    align: 'center',
    ellipsis: true,
    render: (row: IRowData) => {
      return h(
        RouterLink,
        {
          to: `/dictData/${row.dictType}`,
          style: `color:#18a058`
        },
        { default: () => row.dictType }
      )
    }
  },
  {
    title: '状态',
    key: 'status',
    width: 80,
    align: 'center',
    render: (row: IRowData) => {
      return h(
        NTag,
        { type: row.status == '0' ? 'success' : 'error' },
        { default: () => (row.status == '0' ? '正常' : '停用') }
      )
    }
  },
  {
    title: '备注',
    key: 'remark',
    width: 160,
    align: 'center',
    ellipsis: true
  },
  {
    title: '创建时间',
    key: 'createTime',
    width: 180,
    align: 'center'
  },
  {
    title: '操作',
    key: 'operation',
    align: 'center',
    fixed: 'right',
    width: 160,
    render(row: IRowData) {
      return h('div', null, [
        // 编辑
        h(
          NTooltip,
          { placement: 'top', trigger: 'hover' },
          {
            trigger: () =>
              h(
                NButton,
                {
                  type: 'primary',
                  size: 'tiny',
                  style: 'margin:0 8px;vertical-align:sub;',
                  onClick: () => editRow(row)
                },
                {
                  icon: () => h(MSIcon, { name: 'Edit', size: 18 })
                }
              ),
            default: () => '编辑'
          }
        ),
        // 删除
        h(
          NTooltip,
          { placement: 'top', trigger: 'hover' },
          {
            trigger: () =>
              h(
                NPopconfirm,
                {
                  positiveButtonProps: {
                    type: 'error'
                  },
                  onPositiveClick: () => deleteRow(row)
                },
                {
                  trigger: () =>
                    h(
                      NButton,
                      { type: 'error', size: 'tiny', style: 'margin:0 8px;vertical-align:sub;' },
                      {
                        icon: () => h(MSIcon, { name: 'Delete', size: 18 })
                      }
                    ),
                  default: () => '确定删除选中记录？'
                }
              ),
            default: () => '删除'
          }
        )
      ])
    }
  }
]
// 计算宽度
const scrollX = columns.reduce((pre, cur) => {
  if (cur.width) {
    return pre + (cur.width as number)
  }
  return pre
}, 0)

// 分页
const pageSizes = [10, 20, 30, 50]
const total = ref<number>(0)
const queryParams = reactive<GetDictParams>({
  pageNum: 1,
  pageSize: 10,
  orderBy: '',
  dictName: '',
  dictType: '',
  status: null
})
const statusOptions = ref<DictDataInfo[]>([])
const statusSelectFieldNames = {
  labelField: 'dictTag',
  valueField: 'dictValue'
}

const dictStore = useDictStore()
onMounted(async () => {
  getData()
  statusOptions.value = await dictStore.getDictData('sys_normal_disable')
})
const data = ref<DictInfo[]>([])
const checkData = ref<string[]>([])
const handleCheck = (rowKeys: string[]) => {
  checkData.value = rowKeys
}
const getData = async () => {
  show.value = true
  const result = await getDictListApi(queryParams)
  if (result.code === 200) {
    data.value = result.data.list
    total.value = result.data.total
  }
  show.value = false
}
const resetForm = () => {
  queryParams.dictName = ''
  queryParams.dictType = ''
  queryParams.status = null
  getData()
}

const refresh = () => {
  getData()
}

const dictAddRef = ref()
const addRow = () => {
  dictAddRef.value.showModal()
}

const dictEditRef = ref()
const editRow = (item: IRowData) => {
  dictEditRef.value.showModal(item.id)
}

const dictBatchEditRef = ref()
const batchEditRow = () => {
  dictBatchEditRef.value.showModal(checkData.value)
}

const message = useMessage()
const deleteRow = async (item: IRowData) => {
  const result = await deleteDictApi(item.id)
  if (result.code === 200) {
    message.success(result.message)
    checkData.value = []
    getData()
  }
}
const batchDeleteRow = async () => {
  const result = await batchDeleteDictApi(checkData.value)
  if (result.code === 200) {
    message.success(result.message)
    checkData.value = []
    getData()
  }
}

defineOptions({
  name: `${mainRouteName}-dict`
})
</script>
<script lang="ts">
interface IRowData extends DictInfo, RowData {}
</script>

<style lang="scss" scoped>
.container {
  background-color: #fff;
}

.search-form {
  padding: 20px 10px;
}

.pagination {
  padding: 16px 10px 16px 0;
  justify-content: flex-end;
}
</style>
